日期： 2022-04-06

标签： #学习笔记 #技术  #Android 

学习源： 
腾讯课堂 - https://ke.qq.com/webcourse/347420/103755197#taid=12286789037673756&vid=387702296136380051

百度网盘 - https://pan.baidu.com/disk/main?from=homeFlow#/index?category=all&path=%2F%E5%AD%A6%E4%B9%A0%2F%E4%BA%AB%E5%AD%A6VIP%E8%AF%BE%E7%A8%8B%2F3%E6%9C%9F%2F%E3%80%9006%E3%80%91%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%2F%EF%BC%8809%EF%BC%892022.2.15-%E7%BD%91%E7%BB%9C%E5%92%8C%E7%94%B5%E9%87%8F%E7%9A%84%E4%BC%98%E5%8C%96---%E8%B7%AF%E5%93%A5

---
<br>

## 网络优化
## 网络链接过程：
- DNS解析：域名 -> IP
	- HOOK
	- 运营商劫持
	- 公网的路由（映射耗时）
- HttpDNS
	- 引入阿里云SDK，com.aliyun.ams:alicloud-android-httpdns，调用okhttp的dns()接口
	- 域名映射到多个ip地址
	- 客户端通过httpdns服务获取ip地址 -> 选择最优的ip地址（ping，延时低） -> 缓存 -> 容灾（localdns兜底处理）
	- 直连IP：将header中的host字段设置成 ip地址
	- 优化TCP时延高：
		- 缓存，map，hostname：ip
			- 120s~300s 过期时间，过期更新
			- 网络切换时更新
		- 异步解析httpdns
![[Pasted image 20220407215315.png|500]]
```json
"dns": [  
	{ 
		"host": "api.bilibili.com", 
		"client_ip": "58.49.114.214", 
		"ips": [ "116.207.118.12" ], 
		"ttl": 95, 
		"origin_ttl": 180 
	}, 
	{ 
		"host": "app.bilibili.com", 
		"client_ip": "58.49.114.214", 
		"ips": [ "116.207.118.12" ], 
		"ttl": 180, 
		"origin_ttl": 180 
	}
]
```

- 协议：Socket/长连接/HTTP